name: Cherrypick
on:
  workflow_dispatch:
    inputs:
      Env:
        description: "Environment to which cherrypicking"
        required: true
        default: "qa"
        type: choice
        options:
          - qa
      commitIds:
        description: "Commit id's to cherrypick"
        required: true
        type: string
jobs:
  generate-new-tag:
    runs-on: ubuntu-latest
    outputs:
      new_tag: ${{ steps.generate_new_tag.outputs.new_tag }}
      previous_tag: ${{ steps.generate_new_tag.outputs.previous_tag }}
    steps:
      - name: Check out code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: Generate New tag
        uses: ./.github/generate_new_tag
        id: generate_new_tag
        with:
          release-branch: $GITHUB_REF_NAME
          environment: ${{ inputs.Env }}
  cherry-pick:
    needs: generate-new-tag
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: Initialize mandatory git config
        run: |
          git config user.name "GitHub Actions"
          git config user.email noreply@github.com
      - name: validate Branch selected is in last two release branches
        shell: bash
        run: |
          git branch -a | grep release- > branches.txt
          tail -2 branches.txt | grep $GITHUB_REF_NAME
      - name: create new tag
        id: create-tag
        shell: bash
        run: |
          for i in $(echo ${{ inputs.commitIds }}| sed "s/,/ /g" )
          do
              git cherry-pick -x $i
          done
          git push origin $GITHUB_REF_NAME
          git tag ${{ needs.generate-new-tag.outputs.new_tag }}
          git push --tags
          echo "VERSION=$new_tag" >> $GITHUB_ENV
      - name: Generate data for jira submit
        shell: bash
        env:
          REGION: "ALL_REGIONS"
          ENV: "QA"
          DEPLOY_ENV_TYPE: "staging"
          TIME_STAMP: ""
        run: |
          echo "pipeline_url=${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/commit/${GITHUB_SHA}/checks" >> $GITHUB_ENV
          echo "pipeline_id=${GITHUB_RUN_ID}" >> $GITHUB_ENV
          echo "display_name=${GITHUB_REPOSITORY} ${GITHUB_REF_NAME}" >> $GITHUB_ENV
          echo "commit_tag=${{ steps.create-tag.outputs.new-tag }}" >> $GITHUB_ENV
          echo "repo_url=${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}" >> $GITHUB_ENV
          echo "repo_name=${GITHUB_REPOSITORY}" >> $GITHUB_ENV
          echo "deploy_environment_type=${{ env.DEPLOY_ENV_TYPE }}" >> $GITHUB_ENV
          echo "deployment_region=${{ env.REGION }}" >> $GITHUB_ENV
          echo "deploy_environment_display_name=${GITHUB_REPOSITORY} ${{ env.ENV}} ${{ env.REGION }}" >> $GITHUB_ENV
          echo "deploy_region=ALL" >> $GITHUB_ENV
          echo "commit_message=$(cat gitlog_raw.txt | tr '\n' ' ')" >> $GITHUB_ENV
          echo "time_stamp=$(date +"%Y-%m-%dT%H:%M:%S%z")" >> $GITHUB_ENV
      # - name: Update Jira
      #   uses: fjogeleit/http-request-action@v1
      #   with:
      #     url: ${{ secrets.JIRA_APP_URL }}
      #     method: "POST"
      #     customHeaders: '{"Content-Type": "application/json"}'
      #     username: adminuser
      #     password: oF0bBXMn
      #     data: '{"commit_message": "${{ env.commit_message }}", "pipeline_url": "${{ env.pipeline_url }}", "pipeline_id": "${{ env.pipeline_id }}", "display_name": "${{ env.display_name }}", "commit_tag": "${{ env.commit_tag}}", "repo_url": "${{ env.repo_url}}", "repo_name": "${{ env.repo_name }}", "deploy_environment_type": "${{ env.deploy_environment_type}}", "deployment_region": "${{ env.deployment_region }}", "deploy_environment_display_name": "${{ env.deploy_environment_display_name }}", "deploy_region": "${{ env.deploy_region }}",  "time_stamp": "${{ env.time_stamp }}" }'
      - name: Changelog
        id: changelog
        uses: connorsmallman/github-jira-changelog-action@v1.1.4
        with:
          jira_host: "siva273.atlassian.net"
          jira_email: "cvaganesh.v@gmail.com"
          jira_token: "KoyCR6kVSBBGwoeXYpPl07B3"
          jira_base_url: "https://siva273.atlassian.net"
          source_control_range_from: ${{ steps.create-tag.outputs.old-tag }}
          source_control_range_to: ${{ steps.create-tag.outputs.new-tag }}
          # jira_ticket_id_pattern: "TEST-"
      - name: Create a GitHub release
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ steps.create-tag.outputs.new-tag }}
          name: ${{ steps.create-tag.outputs.new-tag }}
          body: ${{ steps.changelog.outputs.changelog_message }}
      - name: Get the changelog message
        run: echo "${{ steps.changelog.outputs.changelog_message }}"
      - name: Slack Notification
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_COLOR: ${{ job.status }}
          SLACK_ICON: https://github.com/rtCamp.png?size=48
          SLACK_MESSAGE: ${{ steps.changelog.outputs.changelog_message }}
          # SLACK_MESSAGE: "New tag ${{ steps.create-tag.outputs.new-tag }} created on branch  ${{ steps.create-tag.outputs.branch-name }} in project ${{ steps.create-tag.outputs.repo-name }} https://github.com/${{ steps.release-name.outputs.repo-name }}/releases/tag/${{ steps.create-tag.outputs.new-tag }} :rocket:"
          SLACK_TITLE: New tag  ${{ steps.create-tag.outputs.new-tag }} created
